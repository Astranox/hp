<VirtualHost *:80>
    ServerName jabber.at
    ServerAlias www.jabber.at
    Use basic jabber.at
    Use ssl-only
    Use logging jabber.at warn
</VirtualHost>

<VirtualHost *:443>
    ServerName jabber.at
    ServerAlias www.jabber.at
    ServerAlias jabber.zone
    ServerAlias www.jabber.zone
    ServerAlias xmpp.zone
    ServerAlias www.xmpp.zone
    ServerAlias jabber.fsinf.at
    ServerAlias jabber.wien
    ServerAlias www.jabber.wien

    Use basic jabber.at
    use ssl-letsencrypt jabber.at

    Header always set Content-Security-Policy "default-src 'self';"

    # Redirect wrong hostnames to the correct hostname.
    RewriteEngine On
    RewriteCond %{HTTP_HOST} ^www.jabber.at$
    RewriteRule (.*) https://jabber.at$1 [R=301,L]
    RewriteCond %{HTTP_HOST} ^www.jabber.zone$
    RewriteRule (.*) https://jabber.zone$1 [R=301,L]
    RewriteCond %{HTTP_HOST} ^www.xmpp.zone$
    RewriteRule (.*) https://xmpp.zone$1 [R=301,L]

    # Old hostnames (jabber.wien, jabber.fsinf.at) all go to jabber.at
    RewriteCond %{HTTP_HOST} ^jabber.wien$
    RewriteRule (.*) https://jabber.at$1 [R=301,L]
    RewriteCond %{HTTP_HOST} ^www.jabber.wien$
    RewriteRule (.*) https://jabber.at$1 [R=301,L]
    RewriteCond %{HTTP_HOST} ^jabber.fsinf.at$
    RewriteRule (.*) https://jabber.at$1 [R=301,L]

    Alias /doc/ /var/www/jabber.at/doc/
    Alias /static/ /var/www/jabber.at/static/
    Alias /favicon.ico /var/www/jabber.at/static/favicon/favicon.ico
    Alias /robots.txt /var/www/jabber.at/static/robots.txt
    Alias /.well-known/ /var/www/jabber.at/.well-known/
    # Validate google search console - don't remove!
    Alias /google65bb49afe5a62fe1.html /var/www/jabber.at/static/google65bb49afe5a62fe1.html
    Alias /google359e555f66a8412e.html /var/www/jabber.at/static/google359e555f66a8412e.html
    <Directory /var/www/jabber.at/>
            Options -FollowSymLinks -Indexes -ExecCGI -MultiViews
            AllowOverride none
    </Directory>
    <Directory /var/www/jabber.at/logs/>
            Options -FollowSymlinks +Indexes -ExecCGI -MultiViews
            AllowOverride none
    </Directory>

    # Temporary alias for HTTP upload files (remove 2016-11-10)
    Alias /media/ /var/www/upload.jabber.at/
    <Directory /var/www/upload.jabber.at/>
            Options -FollowSymLinks -Indexes -ExecCGI -MultiViews
            AllowOverride none
    </Directory>

    <Location /xep0363/slot>
            Require ip 128.130.95.44 2001:629:3200:95::1:44 128.130.95.45 2001:629:3200:95::1:45
    </Location>

    # TinyMCE and MPTT admin in the admin interface use inline CSS/JS.
    <LocationMatch /admin/core/(page|blogpost|menuitem)/>
        Header always set Content-Security-Policy "default-src 'self'; style-src 'unsafe-inline' 'self'; script-src 'unsafe-inline' 'self'"
    </LocationMatch>
    <Location /static/tiny_mce>
        Header always set Content-Security-Policy "default-src 'self'; style-src 'unsafe-inline' 'self'; script-src 'unsafe-inline' 'self'"
    </Location>

    # JSXC (webchat) needs to connect to http.jabber.at, obviously
    <Location /jsxc>
        Header always set Content-Security-Policy "default-src 'self'; connect-src https://http.jabber.at/http-bind/ 'self';"
    </Location>
    <Location /conversejs>
        Header always set Content-Security-Policy "default-src 'self'; connect-src https://http.jabber.at/http-bind/ 'self';"
    </Location>

    # Icons vor directory listings (/logs)
    Alias /icons/ /usr/share/apache2/icons/
    <Directory /usr/share/apache2/icons/>
            Options -FollowSymLinks -Indexes -ExecCGI -MultiViews
            AllowOverride none
    </Directory>

    # Rewrite some URLs that generally no longer work first
    RewriteRule ^/en/node/([0-9]*)/.* https://jabber.at/en/node/$1
    RewriteRule ^/de/node/([0-9]*)/.* https://jabber.at/de/node/$1
    RewriteRule ^/de/comment/reply/([0-9]*)$ https://jabber.at/de/node/$1
    RewriteRule ^/en/comment/reply/([0-9]*)$ https://jabber.at/en/node/$1

    # Rewrite some still-popular old URLs to new URLs
    RewriteRule ^/de$ https://jabber.at
    RewriteRule ^/de/Clients$ https://jabber.at/clients/
    RewriteRule ^/de/[pP]rivatsphäre$ https://jabber.at/p/privatsphäre/
    RewriteRule ^/de/about$ https://jabber.at/p/über/
    RewriteRule ^/de/apt-repository$ https://jabber.at/p/apt-repository/
    RewriteRule ^/de/ausfall-am-2492010$ https://jabber.at/b/downtime-october-20-starting-630am/
    RewriteRule ^/de/contact$ https://jabber.at/kontakt/
    RewriteRule ^/de/digest-md5-wird-deaktiviert$ https://jabber.at/b/digest-md5-wird-deaktiviert/
    RewriteRule ^/de/downtime-am-20-oktober-ab-ca-630$ https://jabber.at/b/downtime-am-20-oktober-ab-ca-630/
    RewriteRule ^/de/downtime-neue-transports-am-1992010$ https://jabber.at/b/downtime-neue-transports-am-1992010/
    RewriteRule ^/de/downtime-sonntag-19-dezember-1000$ https://jabber.at/b/short-downtime-sun-december-19-2010-1000-am-cest/
    RewriteRule ^/de/downtime-sonntag-5-juni-1000-0$ https://jabber.at/b/downtime-sonntag-5-juni-1000/
    RewriteRule ^/de/downtimes-am-28-februar-2011-bald-gibts-ipv6$ https://jabber.at/b/downtimes-am-28-februar-2011-bald-gibts-ipv6/
    RewriteRule ^/de/ejabberd-upgrade$ https://jabber.at/b/ejabberd-upgrade/
    RewriteRule ^/de/empfohlene-clients$ https://jabber.at/clients/
    RewriteRule ^/de/features$ https://jabber.at/p/features/
    RewriteRule ^/de/features/apt$ https://jabber.at/p/apt-repository/
    RewriteRule ^/de/features/firewalls$ https://jabber.at/p/features-firewalls/
    RewriteRule ^/de/neue-liste-öffentlicher-jabberxmpp-server$ https://jabber.at/b/new-list-public-jabberxmpp-servers/
    RewriteRule ^/de/neue-seite-zur-registrierung-und-zum-passwort-neu-setzen$ https://jabber.at/b/neue-seite-zur-registrierung-und-zum-passwort-neu-setzen/
    RewriteRule ^/de/neuer-host-jabberwien-0$ https://jabber.at/b/new-host-jabberwien/
    RewriteRule ^/de/node$ https://jabber.at/
    RewriteRule ^/de/node/100/?$ https://jabber.at/b/neue-tls-zertifikate-am-montag-2014-09-01/
    RewriteRule ^/de/node/106$ https://jabber.at/b/homepage-nun-auf-drupal-7/
    RewriteRule ^/de/node/118$ https://jabber.at/b/bessere-verbindung-zu-jabber-at-durch-firewalls/
    RewriteRule ^/de/node/120$ https://jabber.at/b/aktualisierung-auf-ejabberd-14-12-registrierung-deaktiviert/
    RewriteRule ^/de/node/124$ https://jabber.at/b/baldige-änderungen/
    RewriteRule ^/de/node/127$ https://jabber.at/b/bestätigungs-e-mails-mit-gpg-verschlüsseln/
    RewriteRule ^/de/node/129$ https://jabber.at/b/neue-bosh-und-webpresence-urls/
    RewriteRule ^/de/node/131$ https://jabber.at/b/downtime-am-samstag-den-2-mai-ab-9-00/
    RewriteRule ^/de/node/134$ https://jabber.at/b/keine-registrierungen-direkt-im-client-mehr/
    RewriteRule ^/de/node/135$ https://jabber.at/b/6-juli-7-00-upgrade-to-ejabberd-15-06/
    RewriteRule ^/de/node/136$ https://jabber.at/b/july-6th-7-am-cest-upgrade-to-ejabberd-15-06/
    RewriteRule ^/de/node/138$ https://jabber.at/b/trouble-connecting/
    RewriteRule ^/de/node/140$ https://jabber.at/b/warnung-webchat-jabber-at-wurde-gehackt/
    RewriteRule ^/de/node/146$ https://jabber.at/b/6-dezember-9-00-upgrade-to-ejabberd-15-11/
    RewriteRule ^/de/node/154$ https://jabber.at/b/neue-transports-facebook-telegram-whatsapp/
    RewriteRule ^/de/node/158$ https://jabber.at/b/dnssec-für-jabber-at/
    RewriteRule ^/de/node/164$ https://jabber.at/b/23-april-9-00-upgrade-auf-ejabberd-16-03/
    RewriteRule ^/de/node/168$ https://jabber.at/b/may-26th-8-am-cest-upgrade-to-ejabberd-16-04/
    RewriteRule ^/de/node/172$ https://jabber.at/b/new-tls-ssl-certificates/
    RewriteRule ^/de/node/25$ https://jabber.at/p/features/
    RewriteRule ^/de/node/26$ https://jabber.at/p/apt-repository/
    RewriteRule ^/de/node/38$ https://jabber.at/b/extended-downtime-most-likely-august-17th/
    RewriteRule ^/de/node/39$ https://jabber.at/b/extended-downtime-on-most-likely-august-17th/
    RewriteRule ^/de/node/48$ https://jabber.at/b/new-transports/
    RewriteRule ^/de/node/64$ https://jabber.at/b/short-downtime-mon-jan-2-2012-900-am-cest/
    RewriteRule ^/de/node/8$ https://jabber.at/b/welcome-to-jabber-at/
    RewriteRule ^/de/node/99$ https://jabber.at/b/new-tls-certificates-monday-2014-09-01/
    RewriteRule ^/de/passwörter$ https://jabber.at/account/password/reset/
    RewriteRule ^/de/privatsph%C3%A4re$ https://jabber.at/p/privatsphäre/
    RewriteRule ^/de/rss.xml$ https://jabber.at/feed/de/rss.xml
    RewriteRule ^/de/server-server-verschlüsselung-erzwingen-oder-verbindung-zu-gmailcom-behalten$ https://jabber.at/b/server-server-verschlüsselung-erzwingen-oder-verbindung-zu-gmailcom-behalten/
    RewriteRule ^/de/server-upgrade$ https://jabber.at/b/server-upgrade/
    RewriteRule ^/de/update-server-upgrade$ https://jabber.at/b/update-server-upgrade/
    RewriteRule ^/de/webpresence$ https://jabber.at/p/features-webpresence/
    RewriteRule ^/de/webpresence$ https://jabber.at/p/features-webpresence/
    RewriteRule ^/de/über-diesen-server$ https://jabber.at/p/über/
    RewriteRule ^/derss.xml$ https://jabber.at/feed/de/rss.xml
    RewriteRule ^/en$ https://jabber.at
    RewriteRule ^/en/about$ https://jabber.at/p/about/
    RewriteRule ^/en/apt-repository$ https://jabber.at/p/apt-repository/
    RewriteRule ^/en/contact$ https://jabber.at/contact/
    RewriteRule ^/en/disable-digest-md5$ https://jabber.at/b/digest-md5-gone-for-good-no-more-clear-text-passwords/
    RewriteRule ^/en/downtime-monday-august-23-2010-new-ssl-certificate$ https://jabber.at/b/downtime-monday-august-23-2010/
    RewriteRule ^/en/downtimes-likely-feb-28-2011-will-have-ipv6-soon$ https://jabber.at/b/downtimes-likely-feb-28-2011-will-have-ipv6-soon/
    RewriteRule ^/en/ejabberd-upgrade$ https://jabber.at/b/ejabberd-upgrade/
    RewriteRule ^/en/ende-von-http-polling-mit-112014$ https://jabber.at/b/ende-von-http-polling-mit-112014/
    RewriteRule ^/en/features$ https://jabber.at/p/features/
    RewriteRule ^/en/features/firewalls$ https://jabber.at/p/features-firewalls/
    RewriteRule ^/en/features/security$ https://jabber.at/p/features-security/
    RewriteRule ^/en/finally-real-ssl-certificate$ https://jabber.at/b/finally-real-ssl-certificate/
    RewriteRule ^/en/force-server-server-encryption-or-have-gmailcom-connectivity$ https://jabber.at/b/force-server-server-encryption-or-have-gmailcom-connectivity/
    RewriteRule ^/en/how-good-tls-encryption$ https://jabber.at/b/how-good-tls-encryption/
    RewriteRule ^/en/network-related-downtime$ https://jabber.at/b/network-related-downtime/
    RewriteRule ^/en/new-host-jabberwien$ https://jabber.at/b/new-host-jabberwien/
    RewriteRule ^/en/new-host-jabberzone-0$ https://jabber.at/b/neuer-host-jabberzone/
    RewriteRule ^/en/new-list-public-jabberxmpp-servers$ https://jabber.at/b/new-list-public-jabberxmpp-servers/
    RewriteRule ^/en/new-ssl-certificate-sat-8-september-2012-1200-pm-noon$ https://jabber.at/b/new-ssl-certificate-sat-8-september-2012-1200-pm-noon/
    RewriteRule ^/en/new-tls-certificates-monday-2014-09-01$ https://jabber.at/b/new-tls-certificates-monday-2014-09-01/
    RewriteRule ^/en/new-transports$ https://jabber.at/b/new-transports/
    RewriteRule ^/en/node$ https://jabber.at
    RewriteRule ^/en/node/$ https://jabber.at/
    RewriteRule ^/en/node/105$ https://jabber.at/b/homepage-now-on-drupal-7/
    RewriteRule ^/en/node/113$ https://jabber.at/b/disable-digest-md5/
    RewriteRule ^/en/node/115$ https://jabber.at/b/digest-md5-gone-for-good-no-more-clear-text-passwords/
    RewriteRule ^/en/node/117$ https://jabber.at/b/improved-connectivity-through-firewalls-for-jabber-at/
    RewriteRule ^/en/node/119$ https://jabber.at/b/update-to-ejabberd-14-12-registration-temporarily-disabled/
    RewriteRule ^/en/node/123$ https://jabber.at/b/upcoming-changes/
    RewriteRule ^/en/node/125$ https://jabber.at/b/no-more-registration-via-client-on-jabber-at/
    RewriteRule ^/en/node/126$ https://jabber.at/b/gpg-encrypt-your-confirmation-emails/
    RewriteRule ^/en/node/128$ https://jabber.at/b/new-bosh-and-webpresence-urls/
    RewriteRule ^/en/node/130$ https://jabber.at/b/downtime-saturday-may-2-9-00-cest/
    RewriteRule ^/en/node/132$ https://jabber.at/b/change-in-password-reset-policy/
    RewriteRule ^/en/node/134$ https://jabber.at/b/keine-registrierungen-direkt-im-client-mehr/
    RewriteRule ^/en/node/135$ https://jabber.at/b/july-6th-7-am-cest-upgrade-to-ejabberd-15-06/
    RewriteRule ^/en/node/137$ https://jabber.at/b/trouble-connecting/
    RewriteRule ^/en/node/138$ https://jabber.at/b/trouble-connecting/
    RewriteRule ^/en/node/139$ https://jabber.at/b/warning-webchat-jabber-at-was-hacked/
    RewriteRule ^/en/node/141$ https://jabber.at/b/hack-update-almost-all-services-restored/
    RewriteRule ^/en/node/142$ https://jabber.at/b/hack-update-fast-alles-geht-wieder/
    RewriteRule ^/en/node/145$ https://jabber.at/b/december-6th-9-am-cest-upgrade-to-ejabberd-15-11/
    RewriteRule ^/en/node/147$ https://jabber.at/b/debian-ubuntu-server-admins-let-s-encrypt-packages/
    RewriteRule ^/en/node/148$ https://jabber.at/b/debian-ubuntu-server-admins-let-s-encrypt-packages/
    RewriteRule ^/en/node/149$ https://jabber.at/b/january-31st-9-am-cest-upgrade-to-ejabberd-16-01/
    RewriteRule ^/en/node/151$ https://jabber.at/b/february-20th-9-a-m-cest-short-downtime-new-ip-addresses/
    RewriteRule ^/en/node/152$ https://jabber.at/b/february-20th-9-a-m-cest-short-downtime-new-ip-addresses/
    RewriteRule ^/en/node/153$ https://jabber.at/b/new-transports-facebook-telegram-whatsapp/
    RewriteRule ^/en/node/155$ https://jabber.at/b/13-märz-8-00-upgrade-auf-ejabberd-16-02/
    RewriteRule ^/en/node/157$ https://jabber.at/b/dnssec-for-jabber-at/
    RewriteRule ^/en/node/158$ https://jabber.at/b/dnssec-für-jabber-at/
    RewriteRule ^/en/node/159$ https://jabber.at/b/april-13th-11-a-m-cest-downtime-firewall-upgrade/
    RewriteRule ^/en/node/160$ https://jabber.at/b/april-13th-11-a-m-cest-downtime-firewall-upgrade/
    RewriteRule ^/en/node/161$ https://jabber.at/b/deactivated-transports/
    RewriteRule ^/en/node/162$ https://jabber.at/b/deactivated-transports/
    RewriteRule ^/en/node/163$ https://jabber.at/b/april-23th-9-am-cest-upgrade-to-ejabberd-16-03/
    RewriteRule ^/en/node/164$ https://jabber.at/b/april-23th-9-am-cest-upgrade-to-ejabberd-16-03/
    RewriteRule ^/en/node/165$ https://jabber.at/b/update-of-our-privacy-policy/
    RewriteRule ^/en/node/167$ https://jabber.at/b/may-26th-8-am-cest-upgrade-to-ejabberd-16-04/
    RewriteRule ^/en/node/168$ https://jabber.at/b/may-26th-8-am-cest-upgrade-to-ejabberd-16-04/
    RewriteRule ^/en/node/170$ https://jabber.at/b/august-16th-7-30-am-cest-upgrade-to-ejabberd-16-08/
    RewriteRule ^/en/node/171$ https://jabber.at/b/new-tls-ssl-certificates/
    RewriteRule ^/en/node/19$ https://jabber.at/clients/
    RewriteRule ^/en/node/24$ https://jabber.at/p/features/
    RewriteRule ^/en/node/28$ https://jabber.at/p/webpresence/
    RewriteRule ^/en/node/31$ https://jabber.at/b/some-updates/
    RewriteRule ^/en/node/36$ https://jabber.at/b/network-related-downtime/
    RewriteRule ^/en/node/44$ https://jabber.at/b/downtime-new-transports-1992010/
    RewriteRule ^/en/node/45$ https://jabber.at/b/downtime-neue-transports-am-1992010/
    RewriteRule ^/en/node/46$ https://jabber.at/b/downtime-2492010/
    RewriteRule ^/en/node/46/$ https://jabber.at/b/downtime-2492010/
    RewriteRule ^/en/node/48$ https://jabber.at/b/new-transports/
    RewriteRule ^/en/node/52$ https://jabber.at/b/find-us-twitter/
    RewriteRule ^/en/node/53$ https://jabber.at/b/downtimes-likely-feb-28-2011-will-have-ipv6-soon/
    RewriteRule ^/en/node/58$ https://jabber.at/b/short-downtime-thu-juli-28-2011-400-pm-cest/
    RewriteRule ^/en/node/59$ https://jabber.at/b/short-downtime-thu-juli-28-2011-400-pm-cest/
    RewriteRule ^/en/node/64$ https://jabber.at/b/downtime-montag-2-jänner-2012-900/
    RewriteRule ^/en/node/65$ https://jabber.at/b/downtime-montag-2-jänner-2012-900/
    RewriteRule ^/en/node/69$ https://jabber.at
    RewriteRule ^/en/node/79$ https://jabber.at/b/downtime-august-31-2013/
    RewriteRule ^/en/node/81$ https://jabber.at/b/how-good-tls-encryption/
    RewriteRule ^/en/node/86$ https://jabber.at/b/ende-von-http-polling-mit-112014/
    RewriteRule ^/en/node/87$ https://jabber.at/b/downtime-2014-05-10-900-due-server-upgrade/
    RewriteRule ^/en/node/90$ https://jabber.at/b/update-server-upgrade/
    RewriteRule ^/en/node/96$ https://jabber.at/b/update-of-our-privacy-policy/
    RewriteRule ^/en/passwords$ https://jabber.at/account/password/reset/
    RewriteRule ^/en/privacy$ https://jabber.at/p/privacy/
    RewriteRule ^/en/privacy-policy$ https://jabber.at/p/privacy/
    RewriteRule ^/en/recommended-clients$ https://jabber.at/p/recommended-clients/
    RewriteRule ^/en/register$ https://jabber.at/account/register/
    RewriteRule ^/en/rss.xml$ https://jabber.at/feed/en/rss.xml
    RewriteRule ^/en/server-upgrade$ https://jabber.at/b/server-upgrade/
    RewriteRule ^/en/update-privacy-policy$ https://jabber.at/b/update-of-our-privacy-policy/
    RewriteRule ^/en/update-server-upgrade$ https://jabber.at/b/update-server-upgrade/
    RewriteRule ^/en/webpresence$ https://jabber.at/p/webpresence/
    RewriteRule ^/enrss.xml$ https://jabber.at/feed/en/rss.xml
    RewriteRule ^/feed/rss2/de/$ https://jabber.at/feed/de/rss.xml
    RewriteRule ^/feed/rss2/en/$ https://jabber.at/feed/en/rss.xml
    RewriteRule ^/http-bind$ https://http.jabber.at/http-bind/
    RewriteRule ^/login$ https://jabber.at/account/login/
    RewriteRule ^/p/empfohlene-clients/$ https://jabber.at/clients/
    RewriteRule ^/p/recommended-clients/$ https://jabber.at/clients/
    RewriteRule ^/register$ https://jabber.at/account/register/
    RewriteRule ^/sites/jabber.at/files/favicon.ico$ https://jabber.at/favicon.ico
    RewriteRule ^/stats/.*$ https://stats.jabber.at
    RewriteRule ^/user/$ https://jabber.at/account/
    RewriteRule ^/user/login$ https://jabber.at/account/login/

    ProxyPass /static !
    ProxyPass /media !
    ProxyPass /doc !
    ProxyPass /logs !
    ProxyPass /robots.txt !
    ProxyPass /favicon.ico !
    ProxyPass /icons !
    ProxyPass /.well-known !
    ProxyPass /google65bb49afe5a62fe1.html !
    ProxyPass /google359e555f66a8412e.html !
    ProxyPass / unix:/run/hp/uwsgi.socket|uwsgi://127.0.0.1:3036/

    # For webchat (should not bee needed because of CSP header)
    #ProxyPass /http-bind/ https://http.jabber.at/http-bind/
    #ProxyPassReverse /http-bind/ https://http.jabber.at/http-bind/

    Use logging jabber.at info

    # Improve browser-caching
    # -- Deactivated until we build minified CSS/JS with timestamps
    #ExpiresActive on
    #ExpiresDefault "access plus 1 month"
    #ExpiresByType text/html "access plus 0 seconds"
    #ExpiresByType text/css "access plus 1 year"
    #ExpiresByType application/javascript "access plus 1 year"
    #
    #<Location /captcha>
    #        ExpiresByType image/png "access plus 0 seconds"
    #        ExpiresByType application/json "access plus 0 seconds"
    #</Location>

</VirtualHost>
