<VirtualHost *:80>
    ServerName jabber.at
    ServerAlias www.jabber.at
    Use basic jabber.at
    Use ssl-only
    Use logging jabber.at warn
</VirtualHost>

<VirtualHost *:443>
    ServerName jabber.at
    ServerAlias www.jabber.at
    ServerAlias jabber.zone
    ServerAlias www.jabber.zone
    ServerAlias xmpp.zone
    ServerAlias www.xmpp.zone
    ServerAlias jabber.fsinf.at
    ServerAlias jabber.wien
    ServerAlias www.jabber.wien

    Use basic jabber.at
    use ssl-letsencrypt jabber.at

    Header always set Content-Security-Policy "default-src 'self';"

    # Redirect wrong hostnames to the correct hostname.
    RewriteEngine On
    RewriteCond %{HTTP_HOST} ^www.jabber.at$
    RewriteRule (.*) https://jabber.at$1 [R=301,L]
    RewriteCond %{HTTP_HOST} ^www.jabber.zone$
    RewriteRule (.*) https://jabber.zone$1 [R=301,L]
    RewriteCond %{HTTP_HOST} ^www.xmpp.zone$
    RewriteRule (.*) https://xmpp.zone$1 [R=301,L]

    # Old hostnames (jabber.wien, jabber.fsinf.at) all go to jabber.at
    RewriteCond %{HTTP_HOST} ^jabber.wien$
    RewriteRule (.*) https://jabber.at$1 [R=301,L]
    RewriteCond %{HTTP_HOST} ^www.jabber.wien$
    RewriteRule (.*) https://jabber.at$1 [R=301,L]
    RewriteCond %{HTTP_HOST} ^jabber.fsinf.at$
    RewriteRule (.*) https://jabber.at$1 [R=301,L]

    Alias /doc/ /var/www/jabber.at/doc/
    Alias /static/ /var/www/jabber.at/static/
    Alias /favicon.ico /var/www/jabber.at/static/favicon/favicon.ico
    Alias /robots.txt /var/www/jabber.at/static/robots.txt
    <Directory /var/www/jabber.at/>
            Options -FollowSymLinks -Indexes -ExecCGI -MultiViews
            AllowOverride none
    </Directory>
    <Directory /var/www/jabber.at/logs/>
            Options -FollowSymlinks +Indexes -ExecCGI -MultiViews
            AllowOverride none
    </Directory>

    # Temporary alias for HTTP upload files (remove 2016-11-10)
    Alias /media/ /var/www/upload.jabber.at/
    <Directory /var/www/upload.jabber.at/>
            Options -FollowSymLinks -Indexes -ExecCGI -MultiViews
            AllowOverride none
    </Directory>

    <Location /xep0363/slot>
            Require ip 128.130.95.40 2001:629:3200:95::1:40 128.130.95.41 2001:629:3200:95::1:41
    </Location>

    # TinyMCE in the admin interface uses inline CSS/JS.
    <LocationMatch /admin/core/(page|blogpost)/>
        Header always set Content-Security-Policy "default-src 'self'; style-src 'unsafe-inline' 'self'; script-src 'unsafe-inline' 'self'"
    </LocationMatch>
    <Location /static/tiny_mce>
        Header always set Content-Security-Policy "default-src 'self'; style-src 'unsafe-inline' 'self'; script-src 'unsafe-inline' 'self'"
    </Location>

    # JSXC (webchat) needs to connect to http.jabber.at, obviously
    <Location /jsxc>
        Header always set Content-Security-Policy "default-src 'self'; connect-src https://http.jabber.at/http-bind/ 'self';"
    </Location>
    <Location /conversejs>
        Header always set Content-Security-Policy "default-src 'self'; connect-src https://http.jabber.at/http-bind/ 'self';"
    </Location>

    # Rewrite some still-popular old URLs to new URLs
    RewriteRule ^/de$ https://jabber.at
    RewriteRule ^/de/node/118$ https://jabber.at/b/bessere-verbindung-zu-jabber-at-durch-firewalls/
    RewriteRule ^/de/node/120$ https://jabber.at/b/aktualisierung-auf-ejabberd-14-12-registrierung-deaktiviert/
    RewriteRule ^/de/node/124$ https://jabber.at/b/baldige-änderungen/
    RewriteRule ^/de/node/127$ https://jabber.at/b/bestätigungs-e-mails-mit-gpg-verschlüsseln/
    RewriteRule ^/de/node/129$ https://jabber.at/b/neue-bosh-und-webpresence-urls/
    RewriteRule ^/de/node/134$ https://jabber.at/b/keine-registrierungen-direkt-im-client-mehr/
    RewriteRule ^/de/node/154$ https://jabber.at/b/neue-transports-facebook-telegram-whatsapp/
    RewriteRule ^/de/rss.xml$ https://jabber.at/feed/de/rss.xml
    RewriteRule ^/en$ https://jabber.at
    RewriteRule ^/en/apt-repository$ https://jabber.at/p/apt-repository/
    RewriteRule ^/en/contact$ https://jabber.at/contact/
    RewriteRule ^/en/features/firewalls$ https://jabber.at/p/features-firewalls/
    RewriteRule ^/en/how-good-tls-encryption$ https://jabber.at/b/how-good-tls-encryption/
    RewriteRule ^/en/node$ https://jabber.at
    RewriteRule ^/en/node/117$ https://jabber.at/b/improved-connectivity-through-firewalls-for-jabber-at/
    RewriteRule ^/en/node/119$ https://jabber.at/b/update-to-ejabberd-14-12-registration-temporarily-disabled/
    RewriteRule ^/en/node/123$ https://jabber.at/b/upcoming-changes/
    RewriteRule ^/en/node/125$ https://jabber.at/b/no-more-registration-via-client-on-jabber-at/
    RewriteRule ^/en/node/126$ https://jabber.at/b/gpg-encrypt-your-confirmation-emails/
    RewriteRule ^/en/node/135$ https://jabber.at/b/july-6th-7-am-cest-upgrade-to-ejabberd-15-06/
    RewriteRule ^/en/node/139$ https://jabber.at/b/warning-webchat-jabber-at-was-hacked/
    RewriteRule ^/en/node/141$ https://jabber.at/b/hack-update-almost-all-services-restored/
    RewriteRule ^/en/node/147$ https://jabber.at/b/debian-ubuntu-server-admins-let-s-encrypt-packages/
    RewriteRule ^/en/node/153$ https://jabber.at/b/new-transports-facebook-telegram-whatsapp/
    RewriteRule ^/en/node/170$ https://jabber.at/b/august-16th-7-30-am-cest-upgrade-to-ejabberd-16-08/
    RewriteRule ^/en/privacy-policy$ https://jabber.at/p/privacy/
    RewriteRule ^/en/recommended-clients$ https://jabber.at/p/recommended-clients/
    RewriteRule ^/en/rss.xml$ https://jabber.at/feed/en/rss.xml
    RewriteRule ^/en/webpresence$ https://jabber.at/p/webpresence/
    RewriteRule ^/enrss.xml$ https://jabber.at/feed/en/rss.xml
    RewriteRule ^/feed/rss2/de/$ https://jabber.at/feed/de/rss.xml
    RewriteRule ^/feed/rss2/en/$ https://jabber.at/feed/en/rss.xml
    RewriteRule ^/sites/jabber.at/files/favicon.ico$ https://jabber.at/favicon.ico

    ProxyPass /static !
    ProxyPass /media !
    ProxyPass /doc !
    ProxyPass /logs !
    ProxyPass /robots.txt !
    ProxyPass /favicon.ico !
    ProxyPass / unix:/run/hp/uwsgi.socket|uwsgi://127.0.0.1:3036/

    # For webchat (should not bee needed because of CSP header)
    #ProxyPass /http-bind/ https://http.jabber.at/http-bind/
    #ProxyPassReverse /http-bind/ https://http.jabber.at/http-bind/

    Use logging jabber.at info

    # improve browser-caching
    ExpiresActive on
    ExpiresDefault "access plus 1 month"
    ExpiresByType text/html "access plus 0 seconds"
    ExpiresByType text/css "access plus 1 year"
    ExpiresByType application/javascript "access plus 1 year"

    <Location /captcha>
            ExpiresByType image/png "access plus 0 seconds"
            ExpiresByType application/json "access plus 0 seconds"
    </Location>

</VirtualHost>
